name: Create Release from CHANGELOG

on:
  push:
    tags:
      - 'v*'  # 匹配所有以 v 开头的标签，如 v1.0.0, v1.1.0

jobs:
  create-release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Extract Changelog Entry
        id: changelog
        run: |
          VERSION_TAG=${{ github.ref }}
          VERSION=${VERSION_TAG##*/}
          
          # 去掉 'refs/tags/' 前缀
          VERSION=${VERSION#refs/tags/}
          
          # 支持 v1.2.3 格式
          echo "Extracted version: $VERSION"
          
          # 检查 CHANGELOG.md 是否存在
          if [ ! -f CHANGELOG.md ]; then
            echo "ERROR: CHANGELOG.md not found!"
            exit 1
          fi
          
          # 使用 awk 提取当前版本的 changelog 内容
          awk -v version="\\[$VERSION\\]" '
          BEGIN { in_version = 0; found = 0 }
          "^## \\[" version ".*\\]$" { in_version = 1; found = 1; print; next }
          in_version == 1 && /^## \\[/ { in_version = 0 }
          in_version == 1 { print }
          END { if (found == 0) exit 1 }
          ' CHANGELOG.md > extracted_changelog.txt || {
            echo "::warning::Failed to extract changelog for $VERSION. Using fallback."
            echo "No changelog entry found for $VERSION." > extracted_changelog.txt
          }

          # 输出到 GitHub 步骤输出
          echo "body<<EOF" >> $GITHUB_OUTPUT
          cat extracted_changelog.txt >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          name: Release ${{ github.ref_name }}
          body: ${{ steps.changelog.outputs.body }}
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}